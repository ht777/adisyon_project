<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Men√ºs√º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        
        .sticky-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            z-index: 50;
        }
        .product-card {
            transition: transform 0.2s ease-in-out;
        }
        .product-card:hover {
            transform: translateY(-2px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-utensils mr-2"></i>
                    Restaurant Men√ºs√º
                </h1>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-table mr-1"></i>
                    Masa <span id="tableNumber" class="font-semibold">-</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 pb-32">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Men√º y√ºkleniyor...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <p class="text-red-600 mb-4">Men√º y√ºklenirken bir hata olu≈ütu</p>
            <button onclick="loadMenu()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                Tekrar Dene
            </button>
        </div>

        <!-- Categories -->
        <div id="categoriesSection" class="hidden mb-8">
            <div class="flex overflow-x-auto space-x-4 pb-4" id="categoriesList">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsSection" class="hidden">
            <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- No Products State -->
        <div id="noProductsState" class="hidden text-center py-12">
            <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Hen√ºz √ºr√ºn bulunmuyor</p>
        </div>
    </main>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalProductName" class="text-xl font-bold text-gray-800"></h2>
                    <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <img id="modalProductImage" class="w-full h-48 object-cover rounded-lg mb-4" src="" alt="">
                
                <p id="modalProductDescription" class="text-gray-600 mb-4"></p>
                
                <div class="flex justify-between items-center mb-4">
                    <span id="modalProductPrice" class="text-2xl font-bold text-green-600"></span>
                    <span id="modalProductCategory" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm"></span>
                </div>

                <!-- Extras Section -->
                <div id="modalExtrasSection" class="mb-6">
                    <!-- Extras will be loaded here -->
                </div>

                <!-- Special Instructions -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        √ñzel Notlar (ƒ∞steƒüe baƒülƒ±)
                    </label>
                    <textarea 
                        id="modalSpecialInstructions" 
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
                        rows="3"
                        placeholder="√ñzel isteklerinizi buraya yazƒ±n..."
                    ></textarea>
                </div>

                <!-- Add to Cart Button -->
                <button 
                    onclick="addToCartFromModal()" 
                    class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
                >
                    <i class="fas fa-cart-plus mr-2"></i>
                    Sepete Ekle
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Summary (Sticky Bottom) -->
    <div id="cartSummary" class="sticky-bottom hidden">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="bg-blue-500 text-white rounded-lg p-4 flex justify-between items-center">
                <div>
                    <div class="font-semibold">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Sepetiniz
                    </div>
                    <div class="text-sm opacity-90">
                        <span id="cartItemCount">0</span> √ºr√ºn ‚Ä¢ <span id="cartTotal">0.00</span> TL
                    </div>
                </div>
                <button 
                    onclick="showCart()" 
                    class="bg-white text-blue-500 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors"
                >
                    Sipari≈ü Ver
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Sepetiniz</h2>
                    <button onclick="closeCartModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="cartItems" class="space-y-4 mb-6">
                    <!-- Cart items will be loaded here -->
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold">Toplam:</span>
                        <span id="cartModalTotal" class="text-xl font-bold text-green-600">0.00 TL</span>
                    </div>
                    
                    <button 
                        onclick="placeOrder()" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors"
                    >
                        <i class="fas fa-check mr-2"></i>
                        Sipari≈üi Onayla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div id="orderSuccessModal" class="modal">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6 text-center">
            <div class="text-green-500 mb-4">
                <i class="fas fa-check-circle text-6xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Sipari≈üiniz Alƒ±ndƒ±!</h2>
            <p class="text-gray-600 mb-6">Sipari≈üiniz mutfaƒüa iletildi. Hazƒ±r olduƒüunda bildirim alacaksƒ±nƒ±z.</p>
            <button 
                onclick="closeOrderSuccessModal()" 
                class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
            >
                Tamam
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let currentTable = null;
        let categories = [];
        let products = [];
        let cart = [];
        let currentProduct = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Get table number from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tableNumber = urlParams.get('table');
            
            if (tableNumber) {
                currentTable = tableNumber;
                document.getElementById('tableNumber').textContent = tableNumber;
                await loadMenu();
            } else {
                showError('L√ºtfen QR kodu tarayarak men√ºye ula≈üƒ±n');
            }
        }

        async function loadMenu() {
            try {
                showLoading();
                
                // Load categories
                const categoriesResponse = await fetch('/api/products/categories');
                categories = await categoriesResponse.json();
                
                // Load products
                const productsResponse = await fetch('/api/products');
                products = await productsResponse.json();
                
                renderCategories();
                renderProducts();
                hideLoading();
                
            } catch (error) {
                console.error('Error loading menu:', error);
                showError('Men√º y√ºklenirken bir hata olu≈ütu');
            }
        }

        function renderCategories() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            categories.forEach(category => {
                const categoryElement = document.createElement('button');
                categoryElement.className = 'flex-shrink-0 bg-white border border-gray-200 rounded-lg px-4 py-2 hover:bg-gray-50 transition-colors';
                categoryElement.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl mb-1">${category.icon || 'üçΩÔ∏è'}</div>
                        <div class="text-sm font-medium text-gray-700">${category.name}</div>
                    </div>
                `;
                categoryElement.onclick = () => filterByCategory(category.id);
                categoriesList.appendChild(categoryElement);
            });
            
            document.getElementById('categoriesSection').classList.remove('hidden');
        }

        function renderProducts(categoryId = null) {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';
            
            let filteredProducts = products;
            if (categoryId) {
                filteredProducts = products.filter(p => p.category_id === categoryId);
            }
            
            if (filteredProducts.length === 0) {
                document.getElementById('noProductsState').classList.remove('hidden');
                document.getElementById('productsSection').classList.add('hidden');
                return;
            }
            
            document.getElementById('noProductsState').classList.add('hidden');
            document.getElementById('productsSection').classList.remove('hidden');
            
            filteredProducts.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'product-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                productElement.innerHTML = `
                    <img 
                        src="${product.image_url || 'https://via.placeholder.com/300x200?text=√úr√ºn+G√∂rseli'}" 
                        alt="${product.name}" 
                        class="w-full h-48 object-cover"
                        onerror="this.src='https://via.placeholder.com/300x200?text=√úr√ºn+G√∂rseli'"
                    >
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-gray-800">${product.name}</h3>
                            <span class="text-green-600 font-bold">${product.price.toFixed(2)} TL</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${product.description || ''}</p>
                        <button 
                            onclick="showProductDetail(${product.id})" 
                            class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors"
                        >
                            Detaylƒ± G√∂r
                        </button>
                    </div>
                `;
                productsGrid.appendChild(productElement);
            });
        }

        async function showProductDetail(productId) {
            try {
                const response = await fetch(`/api/products/${productId}`);
                currentProduct = await response.json();
                
                document.getElementById('modalProductName').textContent = currentProduct.name;
                document.getElementById('modalProductImage').src = currentProduct.image_url || 'https://via.placeholder.com/300x200?text=√úr√ºn+G√∂rseli';
                document.getElementById('modalProductDescription').textContent = currentProduct.description || '';
                document.getElementById('modalProductPrice').textContent = `${currentProduct.price.toFixed(2)} TL`;
                document.getElementById('modalProductCategory').textContent = currentProduct.category.name;
                
                // Render extras
                renderProductExtras(currentProduct.extra_groups);
                
                // Reset special instructions
                document.getElementById('modalSpecialInstructions').value = '';
                
                document.getElementById('productModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading product detail:', error);
                alert('√úr√ºn detayƒ± y√ºklenirken bir hata olu≈ütu');
            }
        }

        function renderProductExtras(extraGroups) {
            const extrasSection = document.getElementById('modalExtrasSection');
            extrasSection.innerHTML = '';
            
            if (!extraGroups || extraGroups.length === 0) {
                extrasSection.style.display = 'none';
                return;
            }
            
            extrasSection.style.display = 'block';
            
            extraGroups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'mb-4';
                
                const groupTitle = document.createElement('h4');
                groupTitle.className = 'font-medium text-gray-700 mb-2';
                groupTitle.textContent = group.name;
                if (group.is_required) {
                    groupTitle.innerHTML += ' <span class="text-red-500">*</span>';
                }
                groupElement.appendChild(groupTitle);
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-2';
                
                group.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between p-2 border rounded-lg';
                    
                    const itemLabel = document.createElement('label');
                    itemLabel.className = 'flex items-center cursor-pointer';
                    
                    const input = document.createElement('input');
                    input.type = group.max_selections === 1 ? 'radio' : 'checkbox';
                    input.name = `extra_${group.id}`;
                    input.value = item.id;
                    input.className = 'mr-2';
                    
                    itemLabel.appendChild(input);
                    itemLabel.innerHTML += item.name;
                    
                    const itemPrice = document.createElement('span');
                    itemPrice.className = 'text-sm text-gray-600';
                    itemPrice.textContent = `+${item.price.toFixed(2)} TL`;
                    
                    itemElement.appendChild(itemLabel);
                    itemElement.appendChild(itemPrice);
                    itemsContainer.appendChild(itemElement);
                });
                
                groupElement.appendChild(itemsContainer);
                extrasSection.appendChild(groupElement);
            });
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            currentProduct = null;
        }

        function addToCartFromModal() {
            if (!currentProduct) return;
            
            // Get selected extras
            const extras = {};
            const extraGroups = document.querySelectorAll('[id^="modalExtrasSection"] .mb-4');
            
            extraGroups.forEach((group, index) => {
                const groupId = currentProduct.extra_groups[index].id;
                const selectedItems = [];
                
                const inputs = group.querySelectorAll('input:checked');
                inputs.forEach(input => {
                    const itemId = parseInt(input.value);
                    const item = currentProduct.extra_groups[index].items.find(i => i.id === itemId);
                    if (item) {
                        selectedItems.push({
                            id: item.id,
                            name: item.name,
                            price: item.price
                        });
                    }
                });
                
                if (selectedItems.length > 0) {
                    extras[groupId] = selectedItems;
                }
            });
            
            // Get special instructions
            const specialInstructions = document.getElementById('modalSpecialInstructions').value;
            
            // Add to cart
            const cartItem = {
                id: Date.now(),
                product: currentProduct,
                quantity: 1,
                extras: extras,
                specialInstructions: specialInstructions
            };
            
            cart.push(cartItem);
            updateCartSummary();
            closeProductModal();
            
            // Show success message
            showToast('√úr√ºn sepete eklendi!');
        }

        function updateCartSummary() {
            const cartSummary = document.getElementById('cartSummary');
            const cartItemCount = document.getElementById('cartItemCount');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartSummary.classList.add('hidden');
                return;
            }
            
            cartSummary.classList.remove('hidden');
            
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => {
                let itemTotal = item.product.price * item.quantity;
                
                // Add extras price
                Object.values(item.extras).forEach(extraGroup => {
                    extraGroup.forEach(extra => {
                        itemTotal += extra.price * item.quantity;
                    });
                });
                
                return sum + itemTotal;
            }, 0);
            
            cartItemCount.textContent = totalItems;
            cartTotal.textContent = totalPrice.toFixed(2);
        }

        function showCart() {
            renderCartItems();
            document.getElementById('cartModal').classList.add('active');
        }

        function closeCartModal() {
            document.getElementById('cartModal').classList.remove('active');
        }

        function renderCartItems() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-600 text-center">Sepetiniz bo≈ü</p>';
                return;
            }
            
            let totalPrice = 0;
            
            cart.forEach((item, index) => {
                let itemTotal = item.product.price * item.quantity;
                
                // Calculate extras price
                let extrasText = '';
                Object.values(item.extras).forEach(extraGroup => {
                    extraGroup.forEach(extra => {
                        itemTotal += extra.price * item.quantity;
                        extrasText += `<span class="text-xs bg-gray-100 px-2 py-1 rounded mr-1">${extra.name}</span>`;
                    });
                });
                
                totalPrice += itemTotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-center justify-between p-3 border rounded-lg';
                itemElement.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-800">${item.product.name}</h4>
                        <p class="text-sm text-gray-600">${item.product.price.toFixed(2)} TL x ${item.quantity}</p>
                        ${extrasText ? `<div class="mt-1">${extrasText}</div>` : ''}
                        ${item.specialInstructions ? `<p class="text-xs text-gray-500 mt-1">Not: ${item.specialInstructions}</p>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <button 
                            onclick="updateCartItemQuantity(${index}, ${item.quantity - 1})" 
                            class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300"
                        >
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-medium">${item.quantity}</span>
                        <button 
                            onclick="updateCartItemQuantity(${index}, ${item.quantity + 1})" 
                            class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                        <button 
                            onclick="removeCartItem(${index})" 
                            class="bg-red-100 text-red-600 w-8 h-8 rounded-full hover:bg-red-200"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartItems.appendChild(itemElement);
            });
            
            document.getElementById('cartModalTotal').textContent = `${totalPrice.toFixed(2)} TL`;
        }

        function updateCartItemQuantity(index, newQuantity) {
            if (newQuantity <= 0) {
                removeCartItem(index);
                return;
            }
            
            cart[index].quantity = newQuantity;
            updateCartSummary();
            renderCartItems();
        }

        function removeCartItem(index) {
            cart.splice(index, 1);
            updateCartSummary();
            renderCartItems();
        }

        async function placeOrder() {
            if (cart.length === 0) {
                alert('Sepetiniz bo≈ü!');
                return;
            }
            
            try {
                // Prepare order data
                const orderData = {
                    table_id: parseInt(currentTable),
                    items: cart.map(item => ({
                        product_id: item.product.id,
                        quantity: item.quantity,
                        extras: item.extras
                    })),
                    customer_notes: cart.map(item => item.specialInstructions).filter(Boolean).join('; ')
                };
                
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    closeCartModal();
                    cart = [];
                    updateCartSummary();
                    document.getElementById('orderSuccessModal').classList.add('active');
                } else {
                    const error = await response.json();
                    alert(`Sipari≈ü verilirken hata olu≈ütu: ${error.detail || 'Bilinmeyen hata'}`);
                }
                
            } catch (error) {
                console.error('Error placing order:', error);
                alert('Sipari≈ü verilirken bir hata olu≈ütu');
            }
        }

        function closeOrderSuccessModal() {
            document.getElementById('orderSuccessModal').classList.remove('active');
        }

        function showToast(message) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
            toast.innerHTML = `
                <i class="fas fa-check mr-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('categoriesSection').classList.add('hidden');
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('noProductsState').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('categoriesSection').classList.add('hidden');
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('noProductsState').classList.add('hidden');
            
            // Update error message
            document.querySelector('#errorState p').textContent = message;
        }

        function filterByCategory(categoryId) {
            renderProducts(categoryId);
        }

        // WebSocket connection for real-time order updates
        function connectWebSocket() {
            if (!currentTable) return;
            
            const ws = new WebSocket(`ws://${window.location.host}/ws`);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                // Register as customer
                ws.send(JSON.stringify({
                    type: 'register',
                    client_type: 'customer'
                }));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(message) {
            if (message.type === 'order_updated') {
                // Check if this order belongs to our table
                if (message.data.table_id == currentTable) {
                    showToast(`Sipari≈üiniz ${getStatusText(message.data.status)}!`);
                }
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'bekliyor': 'alƒ±ndƒ±',
                'hazirlaniyor': 'hazƒ±rlanƒ±yor',
                'hazir': 'hazƒ±r',
                'teslim_edildi': 'teslim edildi'
            };
            return statusTexts[status] || status;
        }

        // Connect WebSocket after page load
        setTimeout(connectWebSocket, 1000);
    </script>
</body>
</html>